openapi: 3.0.1
info:
  title: RAG Knowledge API
  version: "1.0.0"
  description: |
    Retrieval-Augmented Generation (RAG) システム用API。
    - /ingest: 文書データを登録し、Titan Embeddings でベクトル化して OpenSearch Serverless に格納
    - /query : 質問文に基づきベクトル検索＋Bedrock LLM で回答生成

servers:
  - url: https://api.example.com/prod
    description: Production API

tags:
  - name: Ingestion
    description: RAGで用いるデータのS3への格納に関する操作
  - name: Query
    description: LLMで推論して結果を取得する操作

paths:
  /ingest:
    post:
      tags:
        - Ingestion
      summary: RAGで用いるテキストデータをS3に格納
      description: |
        RAGで用いるテキストデータをS3に格納します。
        S3に格納されたデータはBedrock Knowledge Baseにより自動的にRAGに同期されます。
      security:
        - ApiKeyAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  
  /ingest-file:
    post:
      tags:
        - Ingestion
      summary: RAGで用いるデータ（Word、PDF）をS3に格納 ※実装予定なし
      description: |
        APIで受け取ったファイルをS3に置きます（原本保持のため）。
        APIで受け取ったファイルからテキストを抽出し、チャンク分割した後、
        Titan Embeddings でベクトル化し、
        OpenSearch Serverless にRAGとして格納します。
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query:
    post:
      tags:
        - Query
      summary: RAG を用いて質問に回答する（検索 → 推論）
      description: |
        質問文を Bedrock Knowledge Bases で検索し、結果をもとに LLM が回答を生成します。
        top_k により検索件数を制御できます。
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueryResponse"
        "400":
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    IngestRequest:
      type: object
      properties:
        text:
          type: string
          description: RAG に格納するテキスト本文
        metadata:
          type: object
          description: 任意のメタデータ（source, page, title など）
      required:
        - text

    IngestResponse:
      type: object
      properties:
        document_id:
          type: string
          description: "アップロードされた文書を識別する一意のID"
        s3_key:
          type: string
          description: "保存先S3キー（Knowledge Baseが同期対象とするパス）"
        status:
          type: string
          description: "uploaded（S3への保存成功を示す）"
        message:
          type: string
          description: "Knowledge BaseがS3の文書を自動的に同期することを示す説明文"

    QueryRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: "ユーザーの質問文（LLMが回答を生成するための入力）"
          example: "RAGアーキテクチャについて説明してください。"

        top_k:
          type: integer
          description: "Knowledge Base 検索で返す最大チャンク数。数が多いほど検索精度は上がるが、遅延も増える。"
          default: 5
          example: 5

        llm_params:
          type: object
          description: "LLMへの追加パラメータ。モデル変更や出力調整（最大トークン数 / temperature）を指定できる。"
          properties:
            model:
              type: string
              description: "回答生成に使用するLLMモデル。未指定の場合は環境変数 LLM_MODEL_ID を使用。"
              example: "anthropic.claude-3-sonnet-20240229-v1:0"
            max_tokens:
              type: integer
              description: "出力される最大トークン数（レスポンスの長さを制御）"
              example: 800
            temperature:
              type: number
              format: float
              description: "生成される回答のランダム性（0.0〜1.0推奨）。低いほど回答が安定する。"
              example: 0.2

  
    QueryResponse:
      type: object
      properties:
        answer:
          type: string
        model:
          type: string
          description: "Model ID used to generate LLM answer"
        rag_used:
          type: boolean
          example: true
          description: "Whether RAG retrieval was used"
        hit_count:
          type: integer
          example: 3
          description: "Number of KB chunks retrieved"
        context:
          type: array
          items:
            $ref: "#/components/schemas/RAGContext"
    
    RAGContext:
      type: object
      properties:
        text:
          type: string
        vector_score:
          type: string
        s3_key:
          type: string
        chunk_id:
          type: string
        metadata:
          type: object
          additionalProperties: true

    ErrorResponse:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
